import{g as t,y as e,z as a,O as o,A as i,o as n,c as s,w as l,a as c,P as r,b as p,C as d,f as m,j as h,F as u,l as f,p as k,i as g,L as M,Q as w,k as y,t as v,r as C,s as x,R as A}from"./index-41510e59.js";import{o as b}from"./lodash.97bfd29b.js";import{_ as T,o as _}from"./uni-app.es.5416a578.js";const I=T({props:{color:{type:String,default:"#ff6000"},keyMap:{type:String,default:"1780b36335e4fa508c898378a18674ef"},AMapKeyWeb:{type:String,default:"8d73f322493bde9ad4480d2cc83e69bb"},initLocation:{type:String,default:""},show:{type:Boolean,default:!1},val:{type:String,default:""}},data(){return{list:[],keyword:"",timeId:null,showPlace:!1,amapMarker:{},amapText:{},mapFlag:!1,places:{key:"",keywords:"",location:this.initLocation,type:"all",city:"北京市",citylimit:!0,datatype:"all",children:!0,extensions:"all",radius:8e3,province:"北京市"}}},mounted(){this.keyword=this.val,this.showPlace=this.show;let t=this;t.$nextTick((()=>{t.loop()}))},watch:{show(t,e){this.showPlace=t,this.$nextTick((()=>{this.loop()}))}},methods:{getPlacesParam(e={}){const a=t("userInfo")||{},o={key:this.AMapKeyWeb,keywords:this.keyword,city:a.city||"",province:a.province||""};return{...this.places,...o,...e}},loop(){try{this.initMapWeb()}catch(t){setTimeout((()=>this.loop()),200)}},inputValue(t){this.timeId&&clearTimeout(this.timeId),this.timeId=setTimeout((()=>{this.getPlaces(),this.timeId=null}))},cancel(){this.keyword="",this.list=[];for(let t in this.amapMarker)this.amapMarker[t]&&(this.amapMarker[t].setMap(null),this.amapText[t].setMap(null));this.amapMarker={},this.amapText={},this.closeInfoWindow(),this.markerAmp&&this.markerAmp.setMap(null)},toCancel(){this.$emit("changeShow",!1),this.cancel()},confrom(){const t=[];for(let e in this.amapMarker)this.amapMarker[e]&&t.push(e);t.length&&(this.cancel(),this.$emit("placeChoose",t))},toChecked(t){if(this.mapFlag)return;let e=t.location.split(",");if(t.active=!t.active,t.active)this.addBuildMask(t),this.setMapCenter(e[0],e[1]);else{const e=t.location;this.amapMarker[e].setMap(null),this.amapText[e].setMap(null),this.amapMarker[e]=null,this.amapText[e]=null,console.log(this.amapText[e])}this.closeInfoWindow(),this.mapFlag=!0,setTimeout((()=>{this.mapFlag=!1}),300)},initMapWeb(){e();let a=this;this.map=new AMap.Map("map",{zoom:16,resizeEnable:!0}),this.showControll(),this.map.on("click",(t=>{this.markerAmp&&this.markerAmp.setMap(null),a.addMarker(t.lnglat.lng,t.lnglat.lat)})),this.map.on("rightclick",(function(t){t.preventDefault()}));const o=t("mapGeolocations");o?this.onComplete(o):AMap.plugin("AMap.Geolocation",(function(){var t=new AMap.Geolocation({enableHighAccuracy:!0,timeout:1e4,buttonPosition:"RB",buttonOffset:new AMap.Pixel(10,20),zoomToAccuracy:!0});t.getCurrentPosition(),AMap.event.addListener(t,"complete",a.onComplete),AMap.event.addListener(t,"error",a.onError)}))},onComplete(t){const e=this;if("SUCCESS"==t.info&&t.position){const a=`${t.position.lng}, ${t.position.lat}`;e.addCircle(t.position.lng,t.position.lat),e.addMarker(t.position.lng,t.position.lat),e.getPlaces(a)}a()},onError(t){a()},showControll(){const t=this.map;AMap.plugin(["AMap.ToolBar"],(function(){var e=new AMap.ToolBar;t.addControl(e)})),AMap.plugin(["AMap.Scale"],(function(){var e=new AMap.Scale;t.addControl(e)})),AMap.plugin(["AMap.ControlBar"],(function(){var e=new AMap.ControlBar({position:{top:"50px",right:"10px"}});t.addControl(e)})),AMap.plugin(["AMap.RangingTool"],(function(){var e=new AMap.RangingTool(t);t.addControl(e)}))},addCircle(t,e){var a=new AMap.Circle({center:[t,e],radius:this.places.radius,fillColor:"#FF33FF",fillOpacity:.2,strokeColor:"#FF33FF",strokeWeight:2});this.map.add(a)},addMarker(t,e){var a=new AMap.Icon({image:"//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",imageSize:new AMap.Size(32,42)});this.markerAmp=new AMap.Marker({icon:a,position:[t,e]}),this.markerAmp.setMap(this.map),this.map.setCenter([t,e]),this.map.setZoom(11)},setMapCenter(t,e){this.map.setCenter([t,e]),this.map.setZoom(11)},buildMark(){this.list.filter((t=>t.active)).forEach(((t,e)=>{this.addBuildMask(t)}))},addBuildMask(t){const e={icon:"../../static/images/build.png",position:t.position,title:t.title,location:t.location,address:t.address},a=this,o=e.location;var i=new AMap.Icon({image:e.icon,imageSize:new AMap.Size(24,32)});a.amapText[o]=new AMap.Text({text:e.title,position:[e.position[0],e.position[1]],offset:new AMap.Pixel(0,-50),style:{color:"#ffffff",fontSize:"14px",fontWeight:"bold",textOutline:"2px rgba(0, 0, 0, 0.5)",background:"rgba(0, 0, 0, 0.5)",padding:"6px 8px",borderRadius:"4px",boxShadow:"0 2px 6px rgba(0, 0, 0, 0.3)"},zIndex:1e3});var n=e.title,s=[];s.push(`地址：${e.address}`);var l=new AMap.InfoWindow({isCustom:!0,content:a.createInfoWindow(n,s.join("<br/>"),t),offset:new AMap.Pixel(16,-45)});a.amapMarker[o]=new AMap.Marker({map:a.map,icon:i,position:[e.position[0],e.position[1]],offset:new AMap.Pixel(-13,-30)}),a.amapMarker[o].on("click",(function(){l.open(a.map,a.amapMarker[o].getPosition())})),a.amapText[o].on("click",(function(){l.open(a.map,a.amapMarker[o].getPosition())})),a.amapMarker[o].on("contextmenu",(function(t){console.log(t,99999)})),a.map.add(a.amapText[o])},createInfoWindow(t,e,a){var o=document.createElement("view");o.className="custom-info input-card content-window-card";var i=document.createElement("view"),n=document.createElement("view"),s=document.createElement("img");i.className="info-top",i.style="display:flex;justify-content: space-between;",n.innerHTML=t,s.src="https://webapi.amap.com/images/close2.gif",s.style="width:12px;height:12px",s.onclick=this.closeInfoWindow,i.appendChild(n),i.appendChild(s),o.appendChild(i);var l=document.createElement("view");l.className="info-middle",l.style.backgroundColor="white",l.innerHTML=e,o.appendChild(l);var c=document.createElement("button");c.className="cancel-marker-button",c.innerHTML="取消标记",c.style.padding="6px 10px",c.style.backgroundColor="#fff",c.style.border="1px solid #ccc",c.style.cursor="pointer",c.style.fontSize="12px",c.style.marginTop="10px",c.style.color="#3c9cff",c.addEventListener("click",(()=>{console.log(232323,a),this.toChecked(a)}));var r=document.createElement("view");return r.className="info-bottom",r.style.position="relative",r.style.top="0px",r.style.margin="0 auto",r.appendChild(c),o.appendChild(r),o},closeInfoWindow(){this.map.clearInfoWindow()},getPlaces(t){t&&(this.places.location=t);const e=this.getPlacesParam(),a="https://restapi.amap.com/v3/assistant/inputtips?"+b(e);o({url:a,method:"GET",success:t=>{let e=t.data;if("1"===e.status){this.list=e.tips.filter((t=>t.location&&t.location.length>0));const t=this.amapMarker;this.list.forEach(((e,a)=>{const o=e.location.split(",");e.position=o,e.title=e.name,e.address=e.district+e.address,e.active=!!t[e.location]}))}},fail:t=>{i({title:JSON.stringify(t),icon:"none"})}})}}},[["render",function(t,e,a,o,i,C){const x=k,A=g,b=M,T=w;return i.showPlace?(n(),s(A,{key:0,class:"amap-choose"},{default:l((()=>[c(A,{class:"top-button"},{default:l((()=>[c(x,{class:"cancel",onClick:r(C.toCancel,["prevent"])},{default:l((()=>[p("取消")])),_:1},8,["onClick"]),c(x,{class:"conform",style:d({backgroundColor:a.color}),onClick:r(C.confrom,["prevent"])},{default:l((()=>[p("完成")])),_:1},8,["style","onClick"])])),_:1}),c(A,{class:"map-box"},{default:l((()=>[c(A,{id:"map"})])),_:1}),c(A,{class:"content"},{default:l((()=>[c(A,{class:"search"},{default:l((()=>[c(A,null,{default:l((()=>[c(b,{src:"/assets/search-99d0cdcd.png"}),c(T,{placeholder:"搜索地点",onInput:C.inputValue,modelValue:i.keyword,"onUpdate:modelValue":e[0]||(e[0]=t=>i.keyword=t)},null,8,["onInput","modelValue"])])),_:1}),c(x,{onClick:C.cancel},{default:l((()=>[p("取消")])),_:1},8,["onClick"])])),_:1}),c(A,{class:"main"},{default:l((()=>[(n(!0),m(u,null,h(i.list,((t,e)=>(n(),s(A,{key:e,onClick:r((e=>C.toChecked(t)),["prevent"])},{default:l((()=>[c(A,{class:y({active:t.active})},{default:l((()=>[c(A,null,{default:l((()=>[p(v(t.name),1)])),_:2},1024),c(x,{class:"detail"},{default:l((()=>[p(v(t.district)+v(t.address?"-"+t.address:""),1)])),_:2},1024)])),_:2},1032,["class"]),c(A,null,{default:l((()=>[t.active?(n(),s(x,{key:0,style:d({color:a.color})},{default:l((()=>[p("√")])),_:1},8,["style"])):f("",!0)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})])),_:1})):f("",!0)}],["__scopeId","data-v-fca3e6d0"]]),P={__name:"map",props:{keyword:String},setup(e){const a=C(""),o=C(null);_((t=>{a.value=t.keyword||"",o.value=t.key}));const i=t("userInfo")||{},l=i.latitude||"",c=i.longitude||"",r=C(c?c+","+l:""),p=e=>{const a=t("location")||{};let i=[];e.forEach((t=>{i.push(`(${t})`)})),i=i.join(","),a[o.value]=i,x("location",a),A()},d=t=>{A(),console.log(t,"选中显示")};return(t,e)=>(n(),s(I,{show:"",color:"#3c9cff",initLocation:r.value,val:a.value,onPlaceChoose:p,onChangeShow:d},null,8,["initLocation","val"]))}};export{P as default};
