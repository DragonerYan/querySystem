import{r as a,e,o as t,c as s,w as l,f as o,F as i,j as u,u as r,a as n,m,v as c,i as d,O as p,g as f,E as b,x as v,G as _,h as g,T as y,l as j,k as h,b as k,n as I,y as N,z as x,A as V,p as w}from"./index-c90ba5bc.js";import{_ as S}from"./uv-navbar.d975eda8.js";import{_ as B,r as q,o as C,a as z,b as F}from"./uni-app.es.ab46cff8.js";import{_ as E}from"./uni-notice-bar.acf2060d.js";import{_ as P}from"./uni-icons.ee49e043.js";import{_ as U,b as A}from"./uni-forms.c6775aed.js";import{_ as L}from"./uni-card.3628bd70.js";import{_ as M}from"./uv-button.ea966e7b.js";import{h as T}from"./h-input.05bf4445.js";import{s as D,a as G}from"./info.86943fcb.js";import{f as O,n as R,d as W}from"./index.e3af3885.js";import{j as Y,d as H,k as J,f as K}from"./baseApi.a243367c.js";import{t as Q}from"./toast.da8a3938.js";import{_ as X,o as Z}from"./lodash.dc4dce02.js";import{d as $}from"./dayjs.min.36a7c6bd.js";import"./uv-icon.821d90f4.js";import"./uni-data-picker.31df9a37.js";import"./uni-cloud.es.0b936316.js";import"./uni-data-checkbox.3cc47dcc.js";const aa=B({__name:"exam",props:{form:{}},emits:["write"],setup(p,{emit:f}){const b=p;a("");const v=[{required:!0,errorMessage:"请选择"},{validateFunction:(a,e,t,s)=>{const l=a.label.split("#")[1],o=b.form[l];return o.description&&o.photoPath||e!=D[0].value||s("必须填写问题资料"),!0}}];return(a,b)=>{const _=q(e("uv-button"),M),g=d,y=q(e("uni-forms-item"),U),j=q(e("uni-card"),L);return t(),s(g,{class:"content"},{default:l((()=>[(t(!0),o(i,null,u(r(O)(),((a,e)=>(t(),s(j,{class:"form-card",title:a.title,isFull:!0,key:e},{default:l((()=>[(t(!0),o(i,null,u(a.childrens,(a=>(t(),s(y,{key:a.prop,label:a.name,required:"",name:[a.prop,"indicatorValue"],rules:v},{default:l((()=>[n(T,{msg:p.form[a.prop].indicatorValue,"onUpdate:msg":e=>p.form[a.prop].indicatorValue=e,type:"radio",options:r(D)},null,8,["msg","onUpdate:msg","options"]),m(n(g,null,{default:l((()=>[n(_,{onClick:e=>((a,e)=>{if(a){const a={indicatorId:e.prop,label:e.name};f("write",a)}})(e,a),size:"small",type:"primary",plain:"",text:p.form[a.prop].description?"已填写":"填写信息",class:"btn"},null,8,["onClick","text"])])),_:2},1536),[[c,p.form[a.prop].indicatorValue==r(D)[0].value]])])),_:2},1032,["label","name"])))),128))])),_:2},1032,["title"])))),128))])),_:1})}}},[["__scopeId","data-v-2929a714"]]),ea=B({__name:"index",props:{state:String,communityId:String,courtName:String},setup(u){const m=a("楼栋信息"),c=a(null),B=a(""),O=a(W()),ea=a([]);let ta=[],sa={};C((a=>{a.communityId&&(m.value=R(a),O.value.base=X.assign(O.value.base,a),na())})),z((()=>{la(),oa()}));const la=()=>{const a=p.getters.getBuildBaseInfo;a&&a.base&&(O.value=X.assign(O.value,a),p.commit("removeBuildBaseInfo"))},oa=()=>{let a=f("location");a&&(sa=a,b("location"))},ia=v((()=>G[1].value==B.value||G[2].value==B.value)),ua=a=>{const e=X.assign(O.value.base,a);p.commit("setBuildBaseInfo",{base:e,[e.indicatorId]:O.value[e.indicatorId]}),I({url:"/pages/build/info"})};_((()=>O.value),(a=>{a.base.buildNumber}),{deep:!0}),F((()=>{ra()}));const ra=()=>{b("buildInfoStorage")},na=async()=>{(()=>{const a=f("buildInfoStorage");a&&(O.value=X.assign(O.value,a))})();let a=O.value.base;const{communityId:e,courtName:t,buildNumber:s}=a,l={communityId:e,courtName:t};if(s&&a.state){B.value=a.state;const e=await Y({...l,buildNumber:s});if("0"==e.status){const a=e.data;a.indicatorValueList.forEach((a=>{O.value[a.indicatorId]&&(O.value[a.indicatorId]={...a,indicatorValue:a.indicatorValue+""})}));for(let e in O.value.base)O.value.base[e]=a.basicInfo[e]||""}G[3].value==B.value&&ma(l)}else ma(l)},ma=async a=>{const e=await H(a);ea.value=e.data.filter((a=>"1"!=a.problemState)).map((a=>a.buildNumber)),ta=e.data,B.value||ca()},ca=()=>{0==ea.value.length&&g({title:"楼栋信息",content:"已经没有楼栋可填",success:function(a){(a.confirm||a.cancel)&&y()}})},da=async()=>{const a=$().year(),e=[],t=X.cloneDeep(O.value),s=t.base;ta.forEach((a=>{a.buildNumber==s.buildNumber&&(a.problemState="1",a.state=1)})),delete t.base;for(let l in t){let o=t[l];o.indicatorValue==D[1].value&&(o.description="",o.photoPath=""),o=X.assign(o,{...s,indicatorId:l,reportYear:a,location:sa[s.buildNumber]||""}),delete o.state,e.push(o)}N(),Promise.all([J(e),K(ta)]).then((a=>{x(),V({title:"提交成功",duration:2e3,icon:"none"}),setTimeout((()=>{ra(),y()}),800)}))};return(a,u)=>{const p=q(e("uv-navbar"),S),f=q(e("uni-notice-bar"),E),b=w,v=d,_=q(e("uni-icons"),P),y=q(e("uni-forms-item"),U),N=q(e("uni-card"),L),x=q(e("uni-forms"),A),V=q(e("uv-button"),M);return t(),o(i,null,[n(p,{onLeftClick:ra,title:m.value,border:"",leftIconSize:"50rpx",placeholder:"",autoBack:""},null,8,["title"]),n(v,null,{default:l((()=>[B.value==r(G)[3].value?(t(),s(f,{key:0,text:"审核不通过意见："+O.value.base.reviewComment},null,8,["text"])):j("",!0),n(v,{class:h(["form-box",{mask:r(ia)}])},{default:l((()=>[n(x,{modelValue:O.value,"label-position":"top","label-width":"100%",class:"form-data",ref_key:"formRef",ref:c},{default:l((()=>[n(N,{class:"form-card",isFull:!0},{default:l((()=>[n(y,{label:"选择楼栋",required:"",name:["base","buildNumber"],rules:[{required:!0,errorMessage:"选择楼栋"}]},{label:l((()=>[n(v,{class:"label-title"},{default:l((()=>[n(v,null,{default:l((()=>[n(b,{class:"is-required"},{default:l((()=>[k("*")])),_:1}),n(b,null,{default:l((()=>[k("选择楼栋")])),_:1})])),_:1}),O.value.base.buildNumber?(t(),s(_,{key:0,type:"location",size:"24",onClick:u[0]||(u[0]=a=>((a,e)=>{var t;const s={keyword:(null==(t=O.value.base)?void 0:t.courtName)||"",key:a};I({url:"/pages/home/map?"+Z(s)})})(O.value.base.buildNumber))})):j("",!0)])),_:1})])),default:l((()=>[n(T,{type:B.value?"value":"year",msg:O.value.base.buildNumber,"onUpdate:msg":u[1]||(u[1]=a=>O.value.base.buildNumber=a),options:ea.value,placeholder:"请先选择楼栋"},null,8,["type","msg","options"])])),_:1})])),_:1}),n(v,{class:h({buildmask:!O.value.base.buildNumber})},{default:l((()=>[n(aa,{onWrite:ua,form:O.value},null,8,["form"])])),_:1},8,["class"])])),_:1},8,["modelValue"]),r(ia)?j("",!0):(t(),s(v,{key:0,class:"btns"},{default:l((()=>[n(V,{class:"submit",type:"primary",onClick:u[2]||(u[2]=a=>{c.value.validate().then((a=>{g({title:"提交",content:"一旦提交不可修改,确定提交？",success:a=>{a.confirm?da():a.cancel&&console.log("用户点击了取消")}})})).catch((a=>{Q("请填写完整")}))})},{default:l((()=>[k("提交")])),_:1})])),_:1}))])),_:1},8,["class"])])),_:1})],64)}}},[["__scopeId","data-v-c4ffcc40"]]);export{ea as default};
