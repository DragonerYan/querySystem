import{r as a,e,o as s,c as t,w as l,f as o,F as i,j as u,u as r,a as n,m,v as c,i as d,O as p,g as b,E as f,x as v,G as _,h as g,T as y,l as j,k,b as h,n as I,y as N,z as x,A as V,p as w}from"./index-dc79b2ae.js";import{_ as S}from"./uv-navbar.2dea54b9.js";import{_ as B,r as q,o as C,a as z,b as F}from"./uni-app.es.da9f3327.js";import{_ as E}from"./uni-notice-bar.3fa9dc35.js";import{_ as U}from"./uni-icons.17e858bc.js";import{_ as A,b as L}from"./uni-forms.4e5fca14.js";import{_ as M}from"./uni-card.d7d01fbd.js";import{_ as P}from"./uv-button.726e6cb5.js";import{h as T}from"./h-input.e4fc05cf.js";import{s as D,a as G}from"./info.86943fcb.js";import{f as O,n as R,d as W}from"./index.ce13d71d.js";import{j as Y,d as H,k as J,f as K}from"./baseApi.caad9e83.js";import{t as Q}from"./toast.8d653010.js";import{_ as X,o as Z}from"./lodash.d5e524c4.js";import{d as $}from"./dayjs.min.85051a64.js";import"./uv-icon.802e20ec.js";import"./uni-data-picker.a1a3aad5.js";import"./uni-cloud.es.2e03ab39.js";import"./uni-data-checkbox.1adaad05.js";const aa=B({__name:"exam",props:{form:{}},emits:["write"],setup(p,{emit:b}){const f=p;a("");const v=[{required:!0,errorMessage:"请选择"},{validateFunction:(a,e,s,t)=>{const l=a.label.split("#")[1],o=f.form[l];return o.description&&o.photoPath||e!=D[0].value||t("必须填写问题资料"),!0}}];return(a,f)=>{const _=q(e("uv-button"),P),g=d,y=q(e("uni-forms-item"),A),j=q(e("uni-card"),M);return s(),t(g,{class:"content"},{default:l((()=>[(s(!0),o(i,null,u(r(O)(),((a,e)=>(s(),t(j,{class:"form-card",title:a.title,isFull:!0,key:e},{default:l((()=>[(s(!0),o(i,null,u(a.childrens,(a=>(s(),t(y,{key:a.prop,label:a.name,required:"",name:[a.prop,"indicatorValue"],rules:v},{default:l((()=>[n(T,{msg:p.form[a.prop].indicatorValue,"onUpdate:msg":e=>p.form[a.prop].indicatorValue=e,type:"radio",options:r(D)},null,8,["msg","onUpdate:msg","options"]),m(n(g,null,{default:l((()=>[n(_,{onClick:e=>((a,e)=>{if(a){const a={indicatorId:e.prop,label:e.name};b("write",a)}})(e,a),size:"small",type:"primary",plain:"",text:p.form[a.prop].description?"已填写":"填写信息",class:"btn"},null,8,["onClick","text"])])),_:2},1536),[[c,p.form[a.prop].indicatorValue==r(D)[0].value]])])),_:2},1032,["label","name"])))),128))])),_:2},1032,["title"])))),128))])),_:1})}}},[["__scopeId","data-v-2929a714"]]),ea=B({__name:"index",props:{state:String,communityId:String,courtName:String},setup(u){const m=a("楼栋信息"),c=a(null),B=a(""),O=a(W()),ea=a([]);let sa=[],ta={};C((a=>{a.communityId&&(m.value=R(a),O.value.base=X.assign(O.value.base,a),na())})),z((()=>{la(),oa()}));const la=()=>{const a=p.getters.getBuildBaseInfo;a&&a.base&&(O.value=X.assign(O.value,a),p.commit("removeBuildBaseInfo"))},oa=()=>{let a=b("location");a&&(ta=a,f("location"))},ia=v((()=>G[1].value==B.value||G[2].value==B.value)),ua=a=>{const e=X.assign(O.value.base,a);p.commit("setBuildBaseInfo",{base:e,[e.indicatorId]:O.value[e.indicatorId]}),I({url:"/pages/build/info"})};_((()=>O.value),(a=>{a.base.buildNumber}),{deep:!0}),F((()=>{ra()}));const ra=()=>{f("buildInfoStorage")},na=async()=>{(()=>{const a=b("buildInfoStorage");a&&(O.value=X.assign(O.value,a))})();let a=O.value.base;const{communityId:e,courtName:s,buildNumber:t}=a,l={communityId:e,courtName:s};if(t&&a.state){B.value=a.state;const e=await Y({...l,buildNumber:t});if("0"==e.status){const a=e.data;a.indicatorValueList.forEach((a=>{O.value[a.indicatorId]&&(O.value[a.indicatorId]={...a,indicatorValue:a.indicatorValue+""})}));for(let e in O.value.base)O.value.base[e]=a.basicInfo[e]||""}G[3].value==B.value&&ma(l)}else ma(l)},ma=async a=>{const e=await H(a);ea.value=e.data.filter((a=>"1"!=a.problemState)).map((a=>a.buildNumber)),sa=e.data,B.value||ca()},ca=()=>{0==ea.value.length&&g({title:"楼栋信息",content:"已经没有楼栋可填",success:function(a){(a.confirm||a.cancel)&&y()}})},da=async()=>{const a=$().year(),e=[],s=X.cloneDeep(O.value),t=s.base;sa.forEach((a=>{a.buildNumber==t.buildNumber&&(a.problemState="1",a.state=1)})),delete s.base;for(let l in s){let o=s[l];o.indicatorValue==D[1].value&&(o.description=""),o=X.assign(o,{...t,indicatorId:l,reportYear:a,location:ta[t.buildNumber]||""}),delete o.state,e.push(o)}N(),Promise.all([J(e),K(sa)]).then((a=>{x(),V({title:"提交成功",duration:2e3,icon:"none"}),setTimeout((()=>{ra(),y()}),800)}))};return(a,u)=>{const p=q(e("uv-navbar"),S),b=q(e("uni-notice-bar"),E),f=w,v=d,_=q(e("uni-icons"),U),y=q(e("uni-forms-item"),A),N=q(e("uni-card"),M),x=q(e("uni-forms"),L),V=q(e("uv-button"),P);return s(),o(i,null,[n(p,{onLeftClick:ra,title:m.value,border:"",leftIconSize:"50rpx",placeholder:"",autoBack:""},null,8,["title"]),n(v,null,{default:l((()=>[B.value==r(G)[3].value?(s(),t(b,{key:0,text:"审核不通过意见："+O.value.base.reviewComment},null,8,["text"])):j("",!0),n(v,{class:k(["form-box",{mask:r(ia)}])},{default:l((()=>[n(x,{modelValue:O.value,"label-position":"top","label-width":"100%",class:"form-data",ref_key:"formRef",ref:c},{default:l((()=>[n(N,{class:"form-card",isFull:!0},{default:l((()=>[n(y,{label:"选择楼栋",required:"",name:["base","buildNumber"],rules:[{required:!0,errorMessage:"选择楼栋"}]},{label:l((()=>[n(v,{class:"label-title"},{default:l((()=>[n(v,null,{default:l((()=>[n(f,{class:"is-required"},{default:l((()=>[h("*")])),_:1}),n(f,null,{default:l((()=>[h("选择楼栋")])),_:1})])),_:1}),O.value.base.buildNumber?(s(),t(_,{key:0,type:"location",size:"24",onClick:u[0]||(u[0]=a=>((a,e)=>{var s;const t={keyword:(null==(s=O.value.base)?void 0:s.courtName)||"",key:a};I({url:"/pages/home/map?"+Z(t)})})(O.value.base.buildNumber))})):j("",!0)])),_:1})])),default:l((()=>[n(T,{type:B.value?"value":"year",msg:O.value.base.buildNumber,"onUpdate:msg":u[1]||(u[1]=a=>O.value.base.buildNumber=a),options:ea.value,placeholder:"请先选择楼栋"},null,8,["type","msg","options"])])),_:1})])),_:1}),n(v,{class:k({buildmask:!O.value.base.buildNumber})},{default:l((()=>[n(aa,{onWrite:ua,form:O.value},null,8,["form"])])),_:1},8,["class"])])),_:1},8,["modelValue"]),r(ia)?j("",!0):(s(),t(v,{key:0,class:"btns"},{default:l((()=>[n(V,{class:"submit",type:"primary",onClick:u[2]||(u[2]=a=>{c.value.validate().then((a=>{g({title:"提交",content:"一旦提交不可修改,确定提交？",success:a=>{a.confirm?da():a.cancel&&console.log("用户点击了取消")}})})).catch((a=>{Q("请填写完整")}))})},{default:l((()=>[h("提交")])),_:1})])),_:1}))])),_:1},8,["class"])])),_:1})],64)}}},[["__scopeId","data-v-6ad8e2cf"]]);export{ea as default};
