import{g as t,O as e,P as a,A as i,o,c as s,w as n,a as l,Q as c,b as r,C as p,f as d,j as m,F as h,l as u,p as f,i as k,L as w,R as g,k as y,t as C,r as M,s as v,T as x}from"./index-c90ba5bc.js";import{o as b}from"./lodash.dc4dce02.js";import{_ as S,o as T}from"./uni-app.es.ab46cff8.js";let _=null;const I=S({props:{color:{type:String,default:"#ff6000"},keyMap:{type:String,default:"1780b36335e4fa508c898378a18674ef"},AMapKeyWeb:{type:String,default:"8d73f322493bde9ad4480d2cc83e69bb"},initLocation:{type:String,default:""},show:{type:Boolean,default:!1},val:{type:String,default:""}},data(){return{list:[],keyword:"",timeId:null,showPlace:!1,amapMarker:{},amapText:{},mapFlag:!1,places:{key:"",keywords:"",location:this.initLocation,type:"all",city:"北京市",citylimit:!0,datatype:"all",children:!0,extensions:"all",radius:8e3,province:"北京市"}}},mounted(){this.keyword=this.val,this.showPlace=this.show,this.$nextTick((()=>{this.loop()}))},watch:{show(t,e){this.showPlace=t,this.$nextTick((()=>{this.loop()}))}},methods:{getPlacesParam(e={}){t("userInfo");const a={key:this.AMapKeyWeb,keywords:this.keyword};return{...this.places,...a,...e}},async loop(){_=e.state.AMap,_||(_=await e.dispatch("setAmapSync")),this.initMapWeb()},inputValue(t){this.timeId&&clearTimeout(this.timeId),this.timeId=setTimeout((()=>{this.getPlaces(),this.timeId=null}))},cancel(){this.keyword="",this.list=[];for(let t in this.amapMarker)this.amapMarker[t]&&(this.amapMarker[t].setMap(null),this.amapText[t].setMap(null));this.amapMarker={},this.amapText={},this.closeInfoWindow(),this.markerAmp&&this.markerAmp.setMap(null)},toCancel(){this.$emit("changeShow",!1),this.cancel()},confrom(){const t=[];for(let e in this.amapMarker)this.amapMarker[e]&&t.push(e);t.length&&(this.cancel(),this.$emit("placeChoose",t))},toChecked(t){if(this.mapFlag)return;let e=t.location.split(",");if(t.active=!t.active,t.active)this.addBuildMask(t),this.setMapCenter(e[0],e[1]);else{const e=t.location;this.amapMarker[e].setMap(null),this.amapText[e].setMap(null),this.amapMarker[e]=null,this.amapText[e]=null,console.log(this.amapText[e])}this.closeInfoWindow(),this.mapFlag=!0,setTimeout((()=>{this.mapFlag=!1}),300)},async initMapWeb(){let t=this;this.map=new _.Map("map",{zoom:16,resizeEnable:!0}),this.showControll(),this.map.on("click",(e=>{this.markerAmp&&this.markerAmp.setMap(null),t.addMarker(e.lnglat.lng,e.lnglat.lat)})),this.map.on("rightclick",(function(t){t.preventDefault()}));let a=e.state.location;a||(a=await e.dispatch("setLocationSync")),this.onComplete(a)},onComplete(t){const e=this;if("SUCCESS"==t.info&&t.position){const a=`${t.position.lng}, ${t.position.lat}`;e.addCircle(t.position.lng,t.position.lat),e.addMarker(t.position.lng,t.position.lat),e.getPlaces(a)}},showControll(){_.plugin(["AMap.ToolBar","AMap.Scale","AMap.ControlBar"],function(){var t=new _.ToolBar,e=new _.Scale,a=new _.ControlBar({position:{top:"50px",right:"10px"}});this.map.addControl(t),this.map.addControl(e),this.map.addControl(a)}.bind(this))},addCircle(t,e){var a=new _.Circle({center:[t,e],radius:this.places.radius,fillColor:"#FF33FF",fillOpacity:.2,strokeColor:"#FF33FF",strokeWeight:2});this.map.add(a)},addMarker(t,e){var a=new _.Icon({image:"//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png",imageSize:new _.Size(32,42)});this.markerAmp=new _.Marker({icon:a,position:[t,e]}),this.markerAmp.setMap(this.map),this.map.setCenter([t,e]),this.map.setZoom(11)},setMapCenter(t,e){this.map.setCenter([t,e]),this.map.setZoom(11)},buildMark(){this.list.filter((t=>t.active)).forEach(((t,e)=>{this.addBuildMask(t)}))},addBuildMask(t){const e={icon:"../../static/images/build.png",position:t.position,title:t.title,location:t.location,address:t.address},a=this,i=e.location;var o=new _.Icon({image:e.icon,imageSize:new _.Size(24,32)});a.amapText[i]=new _.Text({text:e.title,position:[e.position[0],e.position[1]],offset:new _.Pixel(-5,-5),style:{color:"#ffffff",fontSize:"14px",fontWeight:"bold",textOutline:"2px rgba(0, 0, 0, 0.5)",background:"rgba(0, 0, 0, 0.5)",padding:"6px 8px",borderRadius:"4px",boxShadow:"0 2px 6px rgba(0, 0, 0, 0.3)"},zIndex:1e3,map:this.map});var s=e.title,n=[];n.push(`地址：${e.address}`);var l=new _.InfoWindow({isCustom:!0,content:a.createInfoWindow(s,n.join("<br/>"),t),offset:new _.Pixel(16,-20),map:this.map});l.setPosition([e.position[0],e.position[1]]),a.amapMarker[i]=new _.Marker({map:a.map,icon:o,position:[e.position[0],e.position[1]],offset:new _.Pixel(-13,-30)}),a.amapMarker[i].on("click",(function(){l.open(a.map,a.amapMarker[i].getPosition())})),a.amapText[i].on("click",(function(){l.open(a.map,a.amapMarker[i].getPosition())})),a.amapMarker[i].on("contextmenu",(function(t){})),a.map.add(a.amapText[i])},createInfoWindow(t,e,a){var i=document.createElement("view");i.className="custom-info input-card content-window-card",i.style.left="-50vw";var o=document.createElement("view"),s=document.createElement("view"),n=document.createElement("img");o.className="info-top",o.style="display:flex;justify-content: space-between;",s.innerHTML=t,n.src="https://webapi.amap.com/images/close2.gif",n.style="width:12px;height:12px",n.onclick=this.closeInfoWindow,o.appendChild(s),o.appendChild(n),i.appendChild(o);var l=document.createElement("view");l.className="info-middle",l.style.backgroundColor="white",l.innerHTML=e,i.appendChild(l);var c=document.createElement("button");c.className="cancel-marker-button",c.innerHTML="取消标记",c.style.padding="6px 10px",c.style.backgroundColor="#fff",c.style.border="1px solid #ccc",c.style.cursor="pointer",c.style.fontSize="12px",c.style.marginTop="10px",c.style.color="#3c9cff",c.addEventListener("click",(()=>{console.log(232323,a),this.toChecked(a)}));var r=document.createElement("view");return r.className="info-bottom",r.style.position="relative",r.style.top="0px",r.style.margin="0 auto",r.appendChild(c),i.appendChild(r),i},closeInfoWindow(){this.map.clearInfoWindow()},getPlaces(t){t&&(this.places.location=t);const e=this.getPlacesParam(),o="https://restapi.amap.com/v3/assistant/inputtips?"+b(e);a({url:o,method:"GET",success:t=>{let e=t.data;if("1"===e.status){this.list=e.tips.filter((t=>t.location&&t.location.length>0));const t=this.amapMarker;this.list.forEach(((e,a)=>{const i=e.location.split(",");e.position=i,e.title=e.name,e.address=e.district+e.address,e.active=!!t[e.location]}))}},fail:t=>{i({title:JSON.stringify(t),icon:"none"})}})}}},[["render",function(t,e,a,i,M,v){const x=f,b=k,S=w,T=g;return M.showPlace?(o(),s(b,{key:0,class:"amap-choose"},{default:n((()=>[l(b,{class:"top-button"},{default:n((()=>[l(x,{class:"cancel",onClick:c(v.toCancel,["prevent"])},{default:n((()=>[r("取消")])),_:1},8,["onClick"]),l(x,{class:"conform",style:p({backgroundColor:a.color}),onClick:c(v.confrom,["prevent"])},{default:n((()=>[r("完成")])),_:1},8,["style","onClick"])])),_:1}),l(b,{class:"map-box"},{default:n((()=>[l(b,{id:"map"})])),_:1}),l(b,{class:"content"},{default:n((()=>[l(b,{class:"search"},{default:n((()=>[l(b,null,{default:n((()=>[l(S,{src:"/assets/search-99d0cdcd.png"}),l(T,{placeholder:"搜索地点",onInput:v.inputValue,modelValue:M.keyword,"onUpdate:modelValue":e[0]||(e[0]=t=>M.keyword=t)},null,8,["onInput","modelValue"])])),_:1}),l(x,{onClick:v.cancel},{default:n((()=>[r("取消")])),_:1},8,["onClick"])])),_:1}),l(b,{class:"main"},{default:n((()=>[(o(!0),d(h,null,m(M.list,((t,e)=>(o(),s(b,{key:e,onClick:c((e=>v.toChecked(t)),["prevent"])},{default:n((()=>[l(b,{class:y({active:t.active})},{default:n((()=>[l(b,null,{default:n((()=>[r(C(t.name),1)])),_:2},1024),l(x,{class:"detail"},{default:n((()=>[r(C(t.district)+C(t.address?"-"+t.address:""),1)])),_:2},1024)])),_:2},1032,["class"]),l(b,null,{default:n((()=>[t.active?(o(),s(x,{key:0,style:p({color:a.color})},{default:n((()=>[r("√")])),_:1},8,["style"])):u("",!0)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1})])),_:1})):u("",!0)}],["__scopeId","data-v-855d8eb9"]]),P={__name:"map",props:{keyword:String},setup(e){const a=M(""),i=M(null);T((t=>{a.value=t.keyword||"",i.value=t.key}));const n=t("userInfo")||{},l=n.latitude||"",c=n.longitude||"",r=M(c?c+","+l:""),p=e=>{const a=t("location")||{};let o=[];e.forEach((t=>{o.push(`(${t})`)})),o=o.join(","),a[i.value]=o,v("location",a),x()},d=t=>{x(),console.log(t,"选中显示")};return(t,e)=>(o(),s(I,{show:"",color:"#3c9cff",initLocation:r.value,val:a.value,onPlaceChoose:p,onChangeShow:d},null,8,["initLocation","val"]))}};export{P as default};
